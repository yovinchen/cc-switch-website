# 5.3 深度链接协议

## 功能说明

CC Switch 支持 `ccswitch://` 深度链接协议，可以通过链接一键导入配置。

**使用场景**：
- 团队共享配置
- 教程中的一键配置
- 跨设备快速同步

## 在线生成工具

CC Switch 提供在线深度链接生成工具：

**访问地址**：[https://farion1231.github.io/cc-switch/deplink.html](https://farion1231.github.io/cc-switch/deplink.html)

### 使用方法

1. 打开上述网页
2. 选择导入类型（供应商/MCP/Prompt）
3. 填写配置信息
4. 点击「生成链接」
5. 复制生成的深度链接
6. 分享给他人或在其他设备使用

## 协议格式

CC Switch 支持两种协议格式：

### V1 协议（推荐）

使用 URL 参数格式，更易读和生成：

```
ccswitch://v1/import?resource={type}&app={app}&name={name}&...
```

**通用参数**：

| 参数 | 必填 | 说明 |
|------|------|------|
| `resource` | 是 | 资源类型：`provider` / `mcp` / `prompt` |
| `app` | 是 | 应用类型：`claude` / `codex` / `gemini` |
| `name` | 是 | 名称 |

**供应商参数**（resource=provider）：

| 参数 | 必填 | 说明 |
|------|------|------|
| `endpoint` | 是 | API 端点地址 |
| `apiKey` | 是 | API 密钥 |
| `homepage` | 否 | 供应商官网 |
| `model` | 否 | 默认模型 |
| `haikuModel` | 否 | Haiku 模型（仅 Claude） |
| `sonnetModel` | 否 | Sonnet 模型（仅 Claude） |
| `opusModel` | 否 | Opus 模型（仅 Claude） |
| `notes` | 否 | 备注 |
| `usageScript` | 否 | 用量查询脚本 |
| `usageEnabled` | 否 | 是否启用用量查询（默认 true） |
| `usageApiKey` | 否 | 用量查询专用 API Key |
| `usageBaseUrl` | 否 | 用量查询专用地址 |
| `usageAutoInterval` | 否 | 自动查询间隔（分钟） |

**示例**：
```
ccswitch://v1/import?resource=provider&app=claude&name=My%20Provider&endpoint=https%3A%2F%2Fapi.example.com&apiKey=sk-xxx
```

### Legacy 协议

使用 Base64 编码的 JSON 数据：

```
ccswitch://import/{type}?data={base64_encoded_data}
```

| 参数 | 说明 |
|------|------|
| `type` | 导入类型：`provider` / `mcp` / `prompt` / `skill` |
| `data` | Base64 编码的配置数据 |

## 导入类型

### 导入供应商

```
ccswitch://import/provider?data=<base64>
```

数据结构：
```json
{
  "name": "供应商名称",
  "appId": "claude",
  "settingsConfig": {
    "env": {
      "ANTHROPIC_API_KEY": "sk-xxx",
      "ANTHROPIC_BASE_URL": "https://api.example.com"
    }
  },
  "websiteUrl": "https://example.com",
  "icon": "cloud",
  "iconColor": "#3b82f6"
}
```

### 导入 MCP 服务器

```
ccswitch://import/mcp?data=<base64>
```

数据结构：
```json
{
  "id": "mcp-fetch",
  "name": "HTTP Fetch",
  "description": "HTTP 请求工具",
  "command": "uvx",
  "args": ["mcp-server-fetch"],
  "transportType": "stdio",
  "apps": {
    "claude": true,
    "codex": true,
    "gemini": false
  }
}
```

### 导入 Prompt 预设

```
ccswitch://import/prompt?data=<base64>
```

数据结构：
```json
{
  "name": "代码审查专家",
  "content": "# 角色\n\n你是一个专业的代码审查专家...",
  "app": "claude"
}
```

### 导入 Skill

```
ccswitch://import/skill?data=<base64>
```

数据结构：
```json
{
  "name": "skill-name",
  "repoOwner": "owner",
  "repoName": "repo",
  "repoBranch": "main",
  "directory": "skills/skill-name"
}
```

## 生成深度链接

### 手动生成

1. 准备配置数据（JSON 格式）
2. 将 JSON 转换为 Base64 编码
3. 拼接成完整 URL

**示例**：

```javascript
const config = {
  name: "My Provider",
  appId: "claude",
  settingsConfig: {
    env: {
      ANTHROPIC_API_KEY: "sk-xxx"
    }
  }
};

const base64 = btoa(JSON.stringify(config));
const url = `ccswitch://import/provider?data=${base64}`;
```

### 在线工具

可以使用在线 Base64 编码工具：
- https://www.base64encode.org/

## 使用深度链接

### 点击链接

在浏览器或其他应用中点击深度链接：

1. 系统会询问是否打开 CC Switch
2. 确认后 CC Switch 打开
3. 显示导入确认对话框
4. 确认导入

### 导入确认

导入前会显示确认对话框，包含：

- 导入类型
- 配置预览
- 确认/取消按钮

**安全提示**：只导入来自可信来源的配置。

## 协议注册

### 自动注册

CC Switch 安装时会自动注册 `ccswitch://` 协议。

### 手动注册

如果协议未正确注册：

**macOS**：
重新安装应用，或运行：
```bash
/usr/bin/open -a "CC Switch" --args --register-protocol
```

**Windows**：
重新安装应用，或检查注册表：
```
HKEY_CLASSES_ROOT\ccswitch
```

**Linux**：
检查 `.desktop` 文件中的 `MimeType` 配置。

## 安全考虑

### 敏感信息

深度链接中可能包含敏感信息（如 API Key）：

- 不要在公开场合分享包含 API Key 的链接
- 分享前移除或替换敏感信息
- 使用安全渠道传输链接

### 验证来源

导入前 CC Switch 会：

1. 验证数据格式
2. 显示配置预览
3. 要求用户确认

### 恶意链接防护

CC Switch 会检查：

- 数据格式是否合法
- 必填字段是否完整
- 配置值是否在合理范围

## 示例链接

### 示例：导入 Claude 供应商

```
ccswitch://import/provider?data=eyJuYW1lIjoiVGVzdCBQcm92aWRlciIsImFwcElkIjoiY2xhdWRlIiwic2V0dGluZ3NDb25maWciOnsiZW52Ijp7IkFOVEhST1BJQ19BUElfS0VZIjoic2steHh4In19fQ==
```

解码后的数据：
```json
{
  "name": "Test Provider",
  "appId": "claude",
  "settingsConfig": {
    "env": {
      "ANTHROPIC_API_KEY": "sk-xxx"
    }
  }
}
```

### 示例：导入 MCP 服务器

```
ccswitch://import/mcp?data=eyJpZCI6Im1jcC1mZXRjaCIsIm5hbWUiOiJIVFRQIEZldGNoIiwiY29tbWFuZCI6InV2eCIsImFyZ3MiOlsibWNwLXNlcnZlci1mZXRjaCJdLCJ0cmFuc3BvcnRUeXBlIjoic3RkaW8iLCJhcHBzIjp7ImNsYXVkZSI6dHJ1ZSwiY29kZXgiOnRydWUsImdlbWluaSI6dHJ1ZX19
```

## 故障排除

### 链接无法打开

**检查**：
1. CC Switch 是否已安装
2. 协议是否正确注册
3. 链接格式是否正确

### 导入失败

**可能原因**：
- Base64 编码错误
- JSON 格式错误
- 缺少必填字段

**解决方法**：
1. 检查原始 JSON 格式
2. 重新进行 Base64 编码
3. 确保所有必填字段都存在
